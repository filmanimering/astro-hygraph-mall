---
// src/components/VideoCard.astro
const { videoUrl, title, description, poster } = Astro.props;

const isYouTube =
  videoUrl?.includes("youtube.com") || videoUrl?.includes("youtu.be");
let embedUrl = "";

if (isYouTube) {
  const videoId = videoUrl.includes("v=")
    ? videoUrl.split("v=")[1].split("&")[0]
    : videoUrl.split("/").pop();
  // Vi lägger till autoplay=1 så den startar direkt när man klickar
  embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
}
---

<div
  class="video-card group bg-slate-950 rounded-2xl overflow-hidden border border-white/5 hover:border-white/20 transition-all duration-300 shadow-xl"
>
  <div class="relative aspect-video bg-black overflow-hidden">
    {
      isYouTube ? (
        <div class="youtube-wrapper w-full h-full cursor-pointer">
          {/* Placeholder: Visas så länge man inte klickat */}
          <div class="placeholder-overlay absolute inset-0 z-10">
            {poster && (
              <img
                src={poster}
                alt={title}
                class="w-full h-full object-cover"
              />
            )}
            <div class="absolute inset-0 flex items-center justify-center bg-black/20 group-hover:bg-black/40 transition-all">
              <div class="w-16 h-16 bg-white/90 rounded-full flex items-center justify-center shadow-2xl group-hover:scale-110 transition-transform">
                <div class="w-0 h-0 border-t-10 border-t-transparent border-l-18 border-l-black border-b-10 border-b-transparent ml-1" />
              </div>
            </div>
          </div>

          {/* Själva iframen: Laddas först när man klickar */}
          <template data-url={embedUrl}>
            <iframe
              src=""
              class="w-full h-full absolute inset-0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
            />
          </template>
        </div>
      ) : (
        <video
          src={videoUrl}
          poster={poster}
          controls
          playsinline
          class="w-full h-full object-contain"
        />
      )
    }
  </div>

  <div class="p-4">
    <!-- {title && <h2 class="text-xl font-semibold text-white mb-2">{title}</h2>} -->
    {
      description && (
        <div
          class=" text-white prose prose-invert prose-p:leading-relaxed"
          set:html={description}
        />
      )
    }
  </div>
</div>

<script>
  // Denna script-tag körs i webbläsaren
  const wrappers = document.querySelectorAll(".youtube-wrapper");

  wrappers.forEach((wrapper) => {
    wrapper.addEventListener("click", () => {
      const template = wrapper.querySelector("template");
      const placeholder = wrapper.querySelector(".placeholder-overlay");
      const url = template?.dataset.url;

      if (template && placeholder && url) {
        const content = template.content.cloneNode(true) as HTMLElement;
        const iframe = content.querySelector("iframe");
        if (iframe) iframe.src = url;

        wrapper.appendChild(content);
        placeholder.remove(); // Tar bort din poster och play-knapp
      }
    });
  });
</script>
