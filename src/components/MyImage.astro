---
interface Props {
  src: any; // Ändrad till any för att tillåta både sträng och Hygraph-objekt
  alt?: string;
  width?: number;
  height?: number;
  class?: string;
  aspect?: "video" | "square" | "auto" | "portrait" | "dynamic";
  fit?: "cover" | "contain";
  loading?: "lazy" | "eager";
  priority?: boolean;
}

const {
  src,
  alt = "",
  width,
  height,
  class: className,
  aspect = "auto",
  fit = "cover",
  loading = "lazy",
  priority = false,
} = Astro.props;

/**
 * 1. SÄKERHETSKONTROLL & OPTIMERING
 * Vi kollar om src är en sträng eller ett Hygraph-objekt för att undvika .split() fel.
 */
const imageUrl = typeof src === "object" ? src?.url : src;

const params = new URLSearchParams();
params.append("auto", "format,compress");
params.append("quality", "75");
if (width) params.append("width", width.toString());

// Rensa URL:en från gamla querys och bygg den optimerade strängen
const baseUrl = imageUrl?.split("?")[0];
const optimizedSrc = baseUrl ? `${baseUrl}?${params.toString()}` : "";

/**
 * 2. DYNAMISK ASPECT RATIO
 * Vi räknar ut ration baserat på faktiska mått om de finns.
 */
const dynamicRatio = width && height ? `${width} / ${height}` : "auto";

const aspectClasses = {
  video: "aspect-video",
  square: "aspect-square",
  portrait: "aspect-[3/4]",
  auto: "", // Vi kör h-auto istället för fast ratio
  dynamic: "",
};

const fitClasses = {
  cover: "object-cover",
  contain: "object-contain",
};
---

<div
  class:list={[
    "relative overflow-hidden",
    // Visa bakgrundsplacerholder endast vid fasta format
    aspect !== "auto" && aspect !== "dynamic" && "bg-slate-200/50 shadow-sm",
    aspectClasses[aspect],
    className,
  ]}
  style={aspect === "dynamic" || (aspect === "auto" && width && height)
    ? `aspect-ratio: ${dynamicRatio};`
    : ""}
>
  {
    imageUrl ? (
      <img
        src={optimizedSrc}
        alt={alt || "Bild"}
        width={width}
        height={height}
        loading={priority ? "eager" : loading}
        fetchpriority={priority ? "high" : "auto"}
        decoding={priority ? "sync" : "async"}
        class:list={[
          "w-full block transition-all duration-300",
          // Om auto/dynamic: låt bilden styra höjden. Annars fyll ut boxen.
          aspect === "auto" || aspect === "dynamic" ? "h-auto" : "h-full",
          fitClasses[fit],
        ]}
      />
    ) : (
      <div class="w-full h-full bg-slate-100 flex items-center justify-center text-[10px] text-slate-400 uppercase tracking-widest">
        Saknar bild
      </div>
    )
  }
</div>
