---
interface Props {
  src: string;
  alt?: string;
  width?: number;
  height?: number;
  class?: string;
  aspect?: "video" | "square" | "auto" | "portrait";
  fit?: "cover" | "contain";
  loading?: "lazy" | "eager";
  priority?: boolean;
}

const {
  src,
  alt = "",
  width,
  height,
  class: className,
  aspect = "video",
  fit = "cover",
  loading = "lazy",
  priority = false,
} = Astro.props;

/**
 * 1. OPTIMERING (Hygraph Transformations)
 * Vi använder parametrar för att låta Hygraph sköta tunga lyft.
 */
const params = new URLSearchParams();
params.append("auto", "format,compress");
params.append("quality", "75");
if (width) params.append("width", width.toString());

// Rensa URL:en från gamla querys
const baseUrl = src?.split("?")[0];
const optimizedSrc = `${baseUrl}?${params.toString()}`;

/**
 * 2. TAILWIND KLASSER
 * Notera att "auto" nu lämnas tom för att inte störa naturlig höjd.
 */
const aspectClasses = {
  video: "aspect-video",
  square: "aspect-square",
  portrait: "aspect-[3/4]",
  auto: "",
};

const fitClasses = {
  cover: "object-cover",
  contain: "object-contain",
};
---

<div
  class:list={[
    "relative overflow-hidden",
    // Vi visar bara placeholder-bakgrunden om vi har en fast ratio
    aspect !== "auto" && "bg-slate-200/50 shadow-sm",
    aspectClasses[aspect],
    className,
  ]}
>
  {
    src ? (
      <img
        src={optimizedSrc}
        alt={alt || "Bild"}
        width={width}
        height={height}
        loading={priority ? "eager" : loading}
        fetchpriority={priority ? "high" : "auto"}
        decoding={priority ? "sync" : "async"}
        class:list={[
          "w-full block transition-all duration-300",
          // HÄR ÄR FIXEN: Om auto, använd h-auto. Annars fyll ut (h-full).
          aspect === "auto" ? "h-auto" : "h-full",
          fitClasses[fit],
        ]}
      />
    ) : (
      /* Fallback om bildkälla saknas helt */
      <div class="w-full h-full bg-slate-100 flex items-center justify-center text-[10px] text-slate-400 uppercase tracking-widest">
        Saknar bild
      </div>
    )
  }
</div>
