---
import FormattedDate from "../../components/FormattedDate.astro";
import Prose from "../../components/Prose.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { hygraphFetch } from "../../lib/hygraph";
import SectionVideo from "../../components/sections/SectionVideo.astro";

// --- PATH GENERERING ---
export async function getStaticPaths() {
  const query = `query GetPaths { blogPosts { slug } }`;
  const data = await hygraphFetch(query);
  const posts = data.blogPosts || [];
  return posts.map((post: any) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;

// --- QUERY FÖR ENSTAKA INLÄGG ---
const SINGLE_POST_QUERY = `
query GetSinglePost($slug: String!) {
  blogPost(where: { slug: $slug }) {
    title
    excerpt
    publishedDate    
    content { html }
    youTubeId
    # 1. Den interna videon (MP4)
    video {
      title
      text
      poster { 
        url 
        width
        height
      }
      video { url }
    }  
    
    seo {
      seoTitle
      seoDescription
      ogImage { url }
      noIndex
    }
  }
  allPosts: blogPosts(first: 4, orderBy: publishedDate_DESC) {
    title
    excerpt
    slug
    publishedDate
  }
  globalSettings {
    siteName   
    logo { url width height }
    navigation { ... on Navigation { label url } }
    footerText
    contactInfo { html }
    seo { seoTitle seoDescription ogImage { url } }
  }
}`;

const data = await hygraphFetch(SINGLE_POST_QUERY, { slug });

const post = data.blogPost;

const settings = data.globalSettings?.[0] || {};
const relatedPosts = data.allPosts
  ?.filter((p: any) => p.slug !== slug)
  .slice(0, 3);

if (!post) return Astro.redirect("/404");
---

<BaseLayout
  settings={settings}
  pageSeo={post.seo}
  globalSeo={settings.seo}
  fallbackTitle={post.title}
>
  <main class="bg-white min-h-screen antialiased">
    <div class="max-w-7xl mx-auto pt-20 lg:pt-24 pb-12 px-6 pt-2 pb-12">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-16">
        {/* HUVUDINNEHÅLL */}
        <article class="lg:col-span-9">
          <header class="mb-12">
            <div class="flex items-center gap-4 mb-4">
              <span class="text-sm uppercase font-semibold text-slate-500">
                <FormattedDate date={new Date(post.publishedDate)} />
              </span>
            </div>

            <h1
              class="text-3xl lg:text-4xl font-bold tracking-tight text-slate-900 leading-tight"
            >
              {post.title}
            </h1>
            <p class="mt-4 text-lg text-slate-600">
              {post.excerpt}
            </p>

            <div class="mt-4 h-1 w-full bg-slate-200 rounded-full"></div>
          </header>

          <div class="mb-4">
            <Prose>
              <div set:html={post.content.html} />
            </Prose>
          </div>

          {/* --- VIDEO-SEKTIONEN --- */}
          <div class="space-y-2 mb-2">
            {/* Renderar den interna videon om den finns */}
            {
              post.video && (
                <div class="border-t border-slate-100 pt-2">
                  <SectionVideo data={post.video} />
                </div>
              )
            }
          </div>
          {/* --- YOUTUBE-VIDEON  --- */}
          <div class="space-y-2 mb-2">
            {/* Renderar youtube videon om den finns */}
            {
              post.youTubeId && (
                <div class="my-12 aspect-video w-full">
                  <iframe
                    src={`https://www.youtube-nocookie.com/embed/${post.youTubeId}`}
                    class="w-full h-full rounded-3xl shadow-lg"
                    allowfullscreen
                  />
                </div>
              )
            }
          </div>
        </article>

        {/* SIDEBAR */}
        <aside class="lg:col-span-3">
          <div class="sticky top-32 space-y-6">
            <h3
              class="text-lg font-semibold text-slate-700 mb-1 pl-4 border-b border-slate-200 pb-2"
            >
              Andra inlägg
            </h3>

            <ul class="space-y-4">
              {
                relatedPosts.map((rel: any) => (
                  <li class="">
                    <a
                      href={`/blog/${rel.slug}`}
                      class="block bg-white border border-slate-100 rounded-2xl p-4 shadow-sm transition hover:shadow-md hover:bg-slate-200"
                    >
                      <span class="block text-xs uppercase mb-1 text-slate-900">
                        <FormattedDate date={new Date(rel.publishedDate)} />
                      </span>
                      <h4 class="text-base font-bold text-slate-900 leading-snug">
                        {rel.title}
                      </h4>
                      <p class="text-sm line-clamp-4">{rel.excerpt}</p>
                    </a>
                  </li>
                ))
              }
            </ul>
          </div>
        </aside>
      </div>
    </div>
  </main>
</BaseLayout>
