---
import FormattedDate from "../../components/FormattedDate.astro";
import MyImage from "../../components/MyImage.astro";
import Prose from "../../components/Prose.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { hygraphFetch } from "../../lib/hygraph";
import { SINGLE_POST_QUERY } from "../../lib/queries";

// --- GENERERA ALLA SIDOR VID BUILD ---
export async function getStaticPaths() {
  // Vi hämtar bara slugs här för att veta vilka sidor som ska byggas
  const query = /* GraphQL */ `
    query GetPaths {
      blogPosts {
        slug
      }
    }
  `;
  const data = await hygraphFetch(query);
  const posts = data.blogPosts || [];
  return posts.map((post: any) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;

// --- HÄMTA DATA (Använder central query) ---
const data = await hygraphFetch(SINGLE_POST_QUERY, { slug });
const post = data?.blogPost;

// Om inlägget inte finns (t.ex. vid felaktig URL)
if (!post) return Astro.redirect("/404");

// Globala inställningar och relaterade inlägg
const settings = data.globalSettings?.[0] || {};
const relatedPosts = data.allPosts
  ?.filter((p: any) => p.slug !== slug)
  .slice(0, 3);
---

<BaseLayout
  settings={settings}
  pageSeo={post.seo}
  globalSeo={settings.seo}
  fallbackTitle={post.title}
>
  <main class="bg-white min-h-screen antialiased">
    <div class="pt-8 px-4 max-w-7xl mx-auto pb-8">
      <div
        class="mb-12 lg:mb-28 grid grid-cols-1 lg:grid-cols-12 gap-4 lg:gap-12"
      >
        <header class="col-span-7">
          <span class="text-sm font-medium text-slate-700">
            <FormattedDate date={new Date(post.publishedDate)} />
          </span>
          <!-- Blogg-kategori länk -->
          <div class="py-2">
            {
              post.blogCategory && (
                <a
                  href={`/blogCategory/${post.blogCategory.slug}`}
                  class="flex w-fit text-sm  font-medium  tracking-widest  
              bg-[#DDE1FF] px-3 py-1 rounded-xl transition delay-100 duration-150 ease-in-out hover:-translate-y-0.5 hover:scale-103 hover:bg-blue-200"
                >
                  {post.blogCategory.displayName}
                </a>
              )
            }
          </div>
          <h1 class="text-3xl lg:text-5xl font-medium">
            {post.title}
          </h1>

          {
            post.excerpt && (
              <p class="mt-4  italic leading-relaxed">{post.excerpt}</p>
            )
          }
        </header>
        <div class="col-span-5">
          <MyImage
            src={post.coverImage.url}
            alt={post.coverImage.altText || data.title || "Galleri bild"}
            width={post.coverImage.width}
            height={post.coverImage.height}
            loading="eager"
            aspect="auto"
            class="transition-transform duration-700 rounded-2xl"
          />
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
        {/* --- HUVUDINNEHÅLL --- */}
        <div class="lg:col-span-9">
          <div class="">
            <Prose>
              <div set:html={post.content.html} />
            </Prose>
          </div>
        </div>

        {/* --- SIDEBAR (Relaterade inlägg) --- */}
        <aside class="lg:col-span-3">
          <div class="sticky top-32 space-y-6">
            <h2
              class="text-lg font-medium mb-1 pl-4 border-b border-slate-200 pb-2 text-slate-800"
            >
              Fler inlägg
            </h2>

            <ul class="space-y-4">
              {
                relatedPosts.map((rel: any) => (
                  <li>
                    <a
                      href={`/blog/${rel.slug}`}
                      class="group block bg-white border border-slate-100 rounded-2xl p-4 
                      shadow-sm transition-all hover:shadow-lg hover:border-slate-200 hover:-translate-y-0.5"
                    >
                      <span class="block text-sm  font-medium mb-1 text-slate-700 group-hover:text-slate-600 transition-colors">
                        <FormattedDate date={new Date(rel.publishedDate)} />
                      </span>
                      <h3 class="text-base font-medium leading-snug text-slate-800 group-hover:text-black">
                        {rel.title}
                      </h3>
                      <p class="text-sm line-clamp-2 text-slate-700 mt-1">
                        {rel.excerpt}
                      </p>
                    </a>
                  </li>
                ))
              }
            </ul>
          </div>
        </aside>
      </div>
    </div>
  </main>
</BaseLayout>
