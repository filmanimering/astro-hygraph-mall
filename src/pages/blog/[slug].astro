---
import FormattedDate from "../../components/FormattedDate.astro";
import Prose from "../../components/Prose.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { hygraphFetch } from "../../lib/hygraph";

export async function getStaticPaths() {
  const query = `query GetPaths { blogPosts { slug } }`;
  const data = await hygraphFetch(query);
  const posts = data.blogPosts || [];
  return posts.map((post: any) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;

const SINGLE_POST_QUERY = `
query GetSinglePost($slug: String!) {
  blogPost(where: { slug: $slug }) {
    title
    publishedDate
    content { html }
    seo {
      seoTitle
      seoDescription
      ogImage { url }
      noIndex
    }
  }
  # Hämta de 4 senaste inläggen för sidebaren
  allPosts: blogPosts(first: 4, orderBy: publishedDate_DESC) {
    title
    slug
    publishedDate
  }
  globalSettings {
    siteName
    logo { url width height }
    navigation { ... on Navigation { label url } }
    footerText
    contactInfo { html }
    seo {
      seoTitle
      seoDescription
      ogImage { url }
    }
  }
}`;

const data = await hygraphFetch(SINGLE_POST_QUERY, { slug });
const post = data.blogPost;
const settings = data.globalSettings?.[0] || {};
const relatedPosts = data.allPosts
  ?.filter((p: any) => p.slug !== slug)
  .slice(0, 3);

if (!post) return Astro.redirect("/404");
---

<BaseLayout
  settings={settings}
  pageSeo={post.seo}
  globalSeo={settings.seo}
  fallbackTitle={post.title}
>
  <main class="bg-white min-h-screen antialiased">
    <div class="max-w-7xl mx-auto px-6 py-12 md:py-20">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-16">
        {/* VÄNSTER: Huvudinnehåll */}
        <article class="lg:col-span-10">
          <header class="mb-12">
            <div class="flex items-center gap-4 mb-6">
              <span class="text-sm tracking-widest uppercase">
                <FormattedDate date={new Date(post.publishedDate)} />
              </span>
              <div class="h-px grow bg-slate-100"></div>
            </div>
            <h1
              class="text-4xl md:text-6xl font-black text-slate-900 leading-[1.1] mb-8"
            >
              {post.title}
            </h1>
          </header>

          <Prose>
            <div set:html={post.content.html} />
          </Prose>
        </article>

        {/* HÖGER: Diskret Sidebar */}
        <aside class="lg:col-span-2">
          <div class="sticky top-32 space-y-12">
            <div>
              <h3
                class="text-sm font-bold uppercase text-slate-800 mb-6 pb-2 border-b border-slate-100"
              >
                Senaste artiklarna
              </h3>
              <ul class="space-y-6">
                {
                  relatedPosts.map((rel: any) => (
                    <li>
                      <a
                        href={`/blog/${rel.slug}`}
                        class="group block no-underline"
                      >
                        <span class="block text-xs text-slate-800 font-medium mb-1 uppercase tracking-wider">
                          <FormattedDate date={new Date(rel.publishedDate)} />
                        </span>
                        <h4 class="text-sm font-semibold text-slate-700 group-hover:text-blue-600 transition-colors leading-snug">
                          {rel.title}
                        </h4>
                      </a>
                    </li>
                  ))
                }
              </ul>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>
</BaseLayout>
