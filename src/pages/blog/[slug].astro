---
import FormattedDate from "../../components/FormattedDate.astro";
import Prose from "../../components/Prose.astro";

import BaseLayout from "../../layouts/BaseLayout.astro";
import { hygraphFetch } from "../../lib/hygraph";

// --- PATH GENERERING ---
export async function getStaticPaths() {
  const query = `query GetPaths { blogPosts { slug } }`;
  const data = await hygraphFetch(query);
  const posts = data.blogPosts || [];
  return posts.map((post: any) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;

// --- QUERY FÖR ENSTAKA INLÄGG ---
const SINGLE_POST_QUERY = `
query GetSinglePost($slug: String!) {
  blogPost(where: { slug: $slug }) {
    title
    publishedDate    
    content { html }
    video {
      title
      text
      poster { url }
      video { url }
    }
   
    seo {
      seoTitle
      seoDescription
      ogImage { url }
      noIndex
    }
  }
  allPosts: blogPosts(first: 4, orderBy: publishedDate_DESC) {
    title
    excerpt
    slug
    publishedDate
  }
  globalSettings {
    siteName   
    logo { url width height }
    navigation { ... on Navigation { label url } }
    footerText
    contactInfo { html }
    seo { seoTitle seoDescription ogImage { url } }
  }
}`;

const data = await hygraphFetch(SINGLE_POST_QUERY, { slug });
const post = data.blogPost;
const settings = data.globalSettings?.[0] || {};
const relatedPosts = data.allPosts
  ?.filter((p: any) => p.slug !== slug)
  .slice(0, 3);

const videoUrl = post?.video?.video?.url || null;
const videoPosterUrl = post?.video?.poster?.url || null;

if (!post) return Astro.redirect("/404");
---

<BaseLayout
  settings={settings}
  pageSeo={post.seo}
  globalSeo={settings.seo}
  fallbackTitle={post.title}
>
  <main class="bg-white min-h-screen antialiased">
    <div class="max-w-7xl mx-auto pt-20 lg:pt-24 pb-12 px-6 py-2">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-16">
        {/* HUVUDINNEHÅLL */}
        <article class="lg:col-span-9">
          <header class="mb-12">
            <div class="flex items-center gap-4 mb-4">
              <span class="text-sm uppercase font-semibold text-slate-500">
                <FormattedDate date={new Date(post.publishedDate)} />
              </span>
            </div>

            <h1
              class="text-3xl lg:text-4xl font-bold tracking-tight text-slate-900"
            >
              {post.title}
            </h1>

            <div class="mt-4 h-1 w-28 bg-slate-300 rounded-full"></div>
          </header>

          <div>
            <Prose>
              <div set:html={post.content.html} />
            </Prose>
          </div>

          {
            videoUrl && (
              <div class="mt-12 p-8 bg-slate-900 rounded-3xl text-white shadow-xl">
                <h3 class="text-2xl font-bold mb-2">{post.video?.title}</h3>
                <p class="text-slate-300 mb-6 text-sm italic">
                  {post.video?.text}
                </p>
                <video
                  controls
                  poster={videoPosterUrl}
                  class="w-full rounded-xl border border-white/10"
                >
                  <source src={videoUrl} type="video/mp4" />
                  Din webbläsare stödjer inte videouppspelning.
                </video>
              </div>
            )
          }
        </article>

        {/* SIDEBAR: RELATERADE INLÄGG */}
        <aside class="lg:col-span-3">
          <div class="sticky top-32 space-y-6">
            <h3
              class="text-lg font-semibold text-slate-700 mb-4 border-b border-slate-200 pb-2"
            >
              Andra inlägg
            </h3>

            <ul class="space-y-4">
              {
                relatedPosts.map((rel: any) => (
                  <li>
                    <a
                      href={`/blog/${rel.slug}`}
                      class="block bg-white/90 border border-slate-100 rounded-2xl p-4 shadow-sm transition hover:shadow-md hover:shadow-slate-900/30 hover:bg-white/95"
                    >
                      <span class="block text-xs font-semibold uppercase text-slate-400 mb-1">
                        <FormattedDate date={new Date(rel.publishedDate)} />
                      </span>
                      <h4 class="text-lg font-bold text-slate-900 leading-snug transition-colors hover:text-slate-700">
                        {rel.title}
                      </h4>
                      {rel.excerpt && (
                        <p class="mt-2 text-sm text-slate-600 line-clamp-3 transition-colors hover:text-slate-700">
                          {rel.excerpt}
                        </p>
                      )}
                    </a>
                  </li>
                ))
              }
            </ul>
          </div>
        </aside>
      </div>
    </div>
  </main>
</BaseLayout>
