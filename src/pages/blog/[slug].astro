---
import FormattedDate from "../../components/FormattedDate.astro";
import Prose from "../../components/Prose.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { hygraphFetch } from "../../lib/hygraph";

// --- PATH GENERERING ---
export async function getStaticPaths() {
  const query = `query GetPaths { blogPosts { slug } }`;
  const data = await hygraphFetch(query);
  const posts = data.blogPosts || [];
  return posts.map((post: any) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;

// --- QUERY FÖR ENSTAKA INLÄGG ---
const SINGLE_POST_QUERY = `
query GetSinglePost($slug: String!) {
  blogPost(where: { slug: $slug }) {
    title
    publishedDate
    content { html }
    video {
      title
      text
      poster { url }
      video { url }
    }
    seo {
      seoTitle
      seoDescription
      ogImage { url }
      noIndex
    }
  }
  allPosts: blogPosts(first: 4, orderBy: publishedDate_DESC) {
    title
    slug
    publishedDate
  }
  globalSettings {
    siteName
    brandColor
    logo { url width height }
    navigation { ... on Navigation { label url } }
    footerText
    contactInfo { html }
    seo { seoTitle seoDescription ogImage { url } }
  }
}`;

const data = await hygraphFetch(SINGLE_POST_QUERY, { slug });
const post = data.blogPost;
const settings = data.globalSettings?.[0] || {};
const relatedPosts = data.allPosts
  ?.filter((p: any) => p.slug !== slug)
  .slice(0, 3);

const videoUrl = post?.video?.video?.url || null;
const videoPosterUrl = post?.video?.poster?.url || null;

if (!post) return Astro.redirect("/404");
---

<BaseLayout
  settings={settings}
  pageSeo={post.seo}
  globalSeo={settings.seo}
  fallbackTitle={post.title}
>
  <main class="bg-white min-h-screen antialiased">
    <div
      class="max-w-7xl mx-auto my-12 pt-8 px-6 bg-(--brand-primary)/10 border border-(--brand-primary)/10 shadow-sm rounded-3xl px-6 py-2"
    >
      {/* --- GRID SYSTEM --- */}
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-16">
        {/* --- VÄNSTER: HUVUDINNEHÅLL --- */}
        <article class="lg:col-span-9">
          {/* Header & Metadata */}
          <header class="mb-12">
            <div class="flex items-center gap-4 mb-6">
              <span
                class="text-xs tracking-[0.2em] uppercase font-bold text-(--brand-text)"
              >
                <FormattedDate date={new Date(post.publishedDate)} />
              </span>
              <div class="h-px grow bg-(--brand-primary)/10"></div>
            </div>

            <h1
              class="text-4xl md:text-6xl font-black text-slate-900 leading-[1.1] mb-2"
            >
              {post.title}
            </h1>
          </header>

          {/* Innehållsyta  */}
          <div class="">
            <Prose>
              <div set:html={post.content.html} />
            </Prose>
          </div>

          {/* Video-sektion (om tillgänglig) */}
          {
            videoUrl && (
              <div class="mt-12 p-8 bg-slate-900 rounded-3xl text-white shadow-xl">
                <h3 class="text-2xl font-bold mb-2">{post.video?.title}</h3>
                <p class="text-slate-300 mb-6 text-sm italic">
                  {post.video?.text}
                </p>
                <video
                  controls
                  poster={videoPosterUrl}
                  class="w-full rounded-xl border border-white/10"
                >
                  <source src={videoUrl} type="video/mp4" />
                  Din webbläsare stödjer inte videouppspelning.
                </video>
              </div>
            )
          }
        </article>

        {/* --- HÖGER: SIDEBAR --- */}
        <aside class="lg:col-span-3">
          <div class="sticky top-32 space-y-12">
            <section>
              <h3
                class="text-[11px] font-black uppercase tracking-[0.2em] text-slate-400 mb-8 flex items-center gap-3"
              >
                Senaste nytt
                <span class="h-px grow bg-slate-100"></span>
              </h3>

              <ul class="space-y-10">
                {
                  relatedPosts.map((rel: any) => (
                    <li>
                      <a
                        href={`/blog/${rel.slug}`}
                        class="group block no-underline"
                      >
                        {/* Datum i sidebar */}
                        <span class="block text-[10px] text-(--brand-text) font-bold mb-2 uppercase tracking-widest">
                          <FormattedDate date={new Date(rel.publishedDate)} />
                        </span>

                        {/* Titel som ändrar färg vid hover */}
                        <h4 class="text-md font-bold text-slate-800 group-hover:text-(--brand-primary) transition-colors leading-tight">
                          {rel.title}
                        </h4>

                        {/* Subtil linje som växer vid hover */}
                        <div class="mt-4 h-0.5 w-4 bg-(--brand-primary)/20 group-hover:w-full transition-all duration-300" />
                      </a>
                    </li>
                  ))
                }
              </ul>
            </section>
          </div>
        </aside>
      </div>
    </div>
  </main>
</BaseLayout>
