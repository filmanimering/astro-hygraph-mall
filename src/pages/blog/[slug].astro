---
import FormattedDate from "../../components/FormattedDate.astro";
import Prose from "../../components/Prose.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { hygraphFetch } from "../../lib/hygraph";

// --- PATH GENERERING ---
export async function getStaticPaths() {
  const query = `query GetPaths { blogPosts { slug } }`;
  const data = await hygraphFetch(query);
  const posts = data.blogPosts || [];
  return posts.map((post: any) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;

// --- QUERY FÖR ENSTAKA INLÄGG (STÄDAD) ---
const SINGLE_POST_QUERY = /* GraphQL */ `
  query GetSinglePost($slug: String!) {
    blogPost(where: { slug: $slug }) {
      title
      excerpt
      publishedDate
      content {
        html
      }

      seo {
        seoTitle
        seoDescription
        ogImage {
          url
        }
        noIndex
      }
    }
    allPosts: blogPosts(first: 4, orderBy: publishedDate_DESC) {
      title
      excerpt
      slug
      publishedDate
    }
    globalSettings {
      siteName
      logo {
        url
        width
        height
      }
      navigation {
        ... on Navigation {
          label
          url
        }
      }

      seo {
        seoTitle
        seoDescription
        ogImage {
          url
        }
      }
    }
  }
`;

const data = await hygraphFetch(SINGLE_POST_QUERY, { slug });
const post = data.blogPost;

// Globala inställningar (använder din föredragna struktur)
const settings = data.globalSettings?.[0] || {};
const relatedPosts = data.allPosts
  ?.filter((p: any) => p.slug !== slug)
  .slice(0, 3);

if (!post) return Astro.redirect("/404");
---

<BaseLayout
  settings={settings}
  pageSeo={post.seo}
  globalSeo={settings.seo}
  fallbackTitle={post.title}
>
  <main class="bg-white min-h-screen antialiased">
    <div class="max-w-7xl mx-auto pb-12 px-6 pt-2">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-16">
        {/* HUVUDINNEHÅLL */}
        <article class="lg:col-span-9">
          <header class="mb-12">
            <div class="flex items-center gap-4 mb-4">
              <span class="text-sm uppercase font-semibold text-slate-500">
                <FormattedDate date={new Date(post.publishedDate)} />
              </span>
            </div>

            <h1 class="text-2xl lg:text-3xl leading-tight">
              {post.title}
            </h1>
            <p class="mt-4 text-slate-600 italic">
              {post.excerpt}
            </p>

            <div class="mt-4 h-1 w-full bg-slate-200 rounded-full"></div>
          </header>

          <div class="mb-4">
            <Prose>
              <div set:html={post.content.html} />
            </Prose>
          </div>
        </article>

        {/* SIDEBAR */}
        <aside class="lg:col-span-3">
          <div class="sticky top-32 space-y-6">
            <h3
              class="text-lg font-medium mb-1 pl-4 border-b border-slate-200 pb-2"
            >
              Andra inlägg
            </h3>

            <ul class="space-y-4">
              {
                relatedPosts.map((rel: any) => (
                  <li>
                    <a
                      href={`/blog/${rel.slug}`}
                      class="block bg-white border border-slate-100 rounded-2xl p-4 shadow-sm transition hover:shadow-md hover:bg-gray-100"
                    >
                      <span class="block text-xs uppercase mb-1 text-slate-900">
                        <FormattedDate date={new Date(rel.publishedDate)} />
                      </span>
                      <h4 class="text-base font-semibold leading-snug">
                        {rel.title}
                      </h4>
                      <p class="text-sm line-clamp-2 text-slate-500">
                        {rel.excerpt}
                      </p>
                    </a>
                  </li>
                ))
              }
            </ul>
          </div>
        </aside>
      </div>
    </div>
  </main>
</BaseLayout>
