---
import FormattedDate from "../../components/FormattedDate.astro";
import Prose from "../../components/Prose.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { hygraphFetch } from "../../lib/hygraph";
import { SINGLE_POST_QUERY } from "../../lib/queries";

// --- GENERERA ALLA SIDOR VID BUILD ---
export async function getStaticPaths() {
  // Vi hämtar bara slugs här för att veta vilka sidor som ska byggas
  const query = /* GraphQL */ `
    query GetPaths {
      blogPosts {
        slug
      }
    }
  `;
  const data = await hygraphFetch(query);
  const posts = data.blogPosts || [];
  return posts.map((post: any) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;

// --- HÄMTA DATA (Använder central query) ---
const data = await hygraphFetch(SINGLE_POST_QUERY, { slug });
const post = data?.blogPost;

// Om inlägget inte finns (t.ex. vid felaktig URL)
if (!post) return Astro.redirect("/404");

// Globala inställningar och relaterade inlägg
const settings = data.globalSettings?.[0] || {};
const relatedPosts = data.allPosts
  ?.filter((p: any) => p.slug !== slug)
  .slice(0, 3);
---

<BaseLayout
  settings={settings}
  pageSeo={post.seo}
  globalSeo={settings.seo}
  fallbackTitle={post.title}
>
  <main class="bg-white min-h-screen antialiased">
    <div class="px-4 max-w-6xl mx-auto pb-8">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-16">
        {/* --- HUVUDINNEHÅLL --- */}
        <article class="lg:col-span-9">
          <header class="mb-12">
            <div class="flex items-center gap-4 mb-4">
              <span class="text-sm font-medium text-slate-700">
                <FormattedDate date={new Date(post.publishedDate)} />
              </span>
            </div>

            <h1 class="text-2xl lg:text-3xl leading-tight text-slate-900">
              {post.title}
            </h1>

            {
              post.excerpt && (
                <p class="mt-4 text-slate-600 italic leading-relaxed">
                  {post.excerpt}
                </p>
              )
            }

            <div class="mt-6 h-px w-full bg-slate-300"></div>
          </header>

          <div class="mb-4">
            <Prose>
              <div set:html={post.content.html} />
            </Prose>
          </div>
        </article>

        {/* --- SIDEBAR (Relaterade inlägg) --- */}
        <aside class="lg:col-span-3">
          <div class="sticky top-32 space-y-6">
            <h2
              class="text-lg font-semibold mb-1 pl-4 border-b border-slate-200 pb-2 text-slate-800"
            >
              Fler inlägg
            </h2>

            <ul class="space-y-4">
              {
                relatedPosts.map((rel: any) => (
                  <li>
                    <a
                      href={`/blog/${rel.slug}`}
                      class="group block bg-white border border-slate-100 rounded-2xl p-4 shadow-sm transition-all hover:shadow-xl hover:border-slate-300 hover:-translate-y-1"
                    >
                      <span class="block text-sm  font-medium mb-1 text-slate-700 group-hover:text-slate-600 transition-colors">
                        <FormattedDate date={new Date(rel.publishedDate)} />
                      </span>
                      <h3 class="text-base font-semibold leading-snug text-slate-800 group-hover:text-black">
                        {rel.title}
                      </h3>
                      <p class="text-sm line-clamp-2 text-slate-700 mt-1">
                        {rel.excerpt}
                      </p>
                    </a>
                  </li>
                ))
              }
            </ul>
          </div>
        </aside>
      </div>
    </div>
  </main>
</BaseLayout>
